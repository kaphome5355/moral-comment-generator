import { GoogleGenAI, GenerateContentResponse, Content } from "@google/genai";

const API_KEY = process.env.API_KEY;

if (!API_KEY) {
  // This case should ideally be handled by the environment providing the key.
  // For robustness in a scenario where it might be missing, we throw an error.
  // The app will catch this and display an error to the user.
  console.error("API_KEY is not configured in environment variables.");
  // We don't throw here to allow the app to load and show a UI error,
  // but API calls will fail.
}

const ai = new GoogleGenAI({ apiKey: API_KEY || "fallback_key_if_not_set_for_initialization_only" }); // Fallback only to allow AI instance creation if key is missing, actual calls will fail.

const MODEL_NAME = "gemini-2.5-flash-preview-04-17";

export const generateMoralComment = async (valueItem: string, keywords: string[]): Promise<string> => {
  if (!API_KEY) {
    throw new Error("Gemini APIキーが設定されていません。");
  }

  const nonEmptyKeywords = keywords.filter(kw => kw.trim() !== '');
  const keywordsPromptPart = nonEmptyKeywords.length > 0
    ? `重視するキーワード: 「${nonEmptyKeywords.join('」「')}」を参考にしてください。`
    : 'キーワードの指定はありません。選択された「価値項目」から判断し、児童の学習の事実と内面的な変化が最もよく現れるような記述を工夫してください。';

  const prompt = `
あなたは小学校の先生です。以下の情報に基づいて、道徳の授業における児童の様子の所見を作成してください。

# 指示
- 所見は120字程度で記述してください。
- 児童の具体的な学習の様子（例: 授業中の発言、グループ討議での態度、作品や発表からうかがえる思考など）と、そこから見られる内面的な気づきや思考の深まり、態度の変化などに焦点を当ててください。
- 特に、以下の点を重視して記述してください。
    - 児童が、扱われた価値項目（例: 正直、親切、公正など）について、その大切さや本質的な意義をより深く理解しようとしている様子。
    - その価値が大切だと頭では理解していても、実際の場面で行動に移すことの難しさや、理想と現実の間での葛藤に気づいている様子。
    - 自分とは異なる友達（他者）の考え方や価値判断にも触れ、それを理解しようとしたり、多様な考えがあることに気づいたりする様子。
- 「ノートへの記述」や「発表」といった行動そのものを記述の主目的にはしないでください。これらの行動は、児童の考えを整理したり、意見を表明したり、他者と交流したりする過程として捉え、それがどのように内面的な気づきや思考の深化に繋がったのかを記述してください。例えば、「〇〇という考えをノートにまとめることを通して、自分の考えを客観的に見つめ直していました」のように、行動と思考の繋がりを示すのは良いですが、「〇〇とノートに書きました」のような単なる行動の報告は避けてください。
- 「探究」という言葉は使用しないでください。
- 「熟考する」という表現は使用せず、「深く考える」「広く考える」「考えを深めていました」などの表現を使用してください。
- あなた（先生）の感情、期待、評価、将来の行動への指示・示唆（例：「頑張ってほしい」「成長した」「素晴らしい」など）は一切含めないでください。
- 客観的な事実と、それに基づく児童の内面の変化の記述に終始してください。
- 文末は「～でした。」、「～ました。」、「～（ように）なりました。」といった丁寧な表現で結んでください。「～（ことが）うかがえます。」や「～（と）言えるでしょう。」といった表現も許容しますが、行動の単なる報告（例：「～と書きました」「～と発表しました」）で文末を終えることは避け、思考や内面の変化を示す記述（例：「～という考えをもちました」「～と捉えるようになりました」）になるよう工夫してください。
- 所見の結びとして、必ずしも「この学習活動から具体的に何を学んだか」を明示的に記述する必要はありません。記述全体を通して児童の成長や変化が伝わることを重視し、自然な流れで所見を終えてください。
- 生成される文章には、上記以外の指示やメタコメント（例：「はい、承知いたしました。」「以下に所見を作成します。」など）は一切含めず、所見の文章本体のみを返してください。

# 対象児童の情報
価値項目: ${valueItem}
${keywordsPromptPart}

# 例文
•	「正直、誠実」の学習では、登場人物の心の葛藤について多角的に考え、自分の考えをノートに丁寧に整理していました。他者の意見にも耳を傾け、誠実さとは何かについて深く考えようとする姿が見られました。
•	「よりよい学校生活」のテーマで、グループでの話し合い活動に積極的に参加しました。特に、友人と「協力」して意見をまとめ、発表の際には互いの貢献に「感謝」の言葉を述べる場面がありました。集団の一員としての自覚と他者への配慮が育まれている様子がうかがえました。
•	「いっしょになってわらっちゃだめだ」の学習では、周りに流されずに行動することの大切さについて考えました。「人がだめなことをしていたら注意する。」と主人公の立場を自分に置き換えて真剣に思考を深めていました。
•	「友達」について考える学習では、「係の仕事をする時に、一人では心配だったけど、友達が一緒だったからできたことがあった。」と、自身の経験から気付きました。これからは、自分も友達を助けていきたいと改めて考えていました。
•	「約束やきまり」について考える学習では、「友達だから横入りさせてと言うのはだめだとわかっているけど、友達だから言えない。でも、我慢するのはおかしい。」と、決まりを守ることの大切さについて葛藤しながらも考えを深めていました。
•	「あこがれのパティシエ」の学習では、個性について考えました。自分の長所と短所を振り返ったり、教材の登場人物の長所を考えたりする中で、自分の行動を変えて長所をもっと増やしていきたいとこれからの自分について考えを広げていました。
•	「修学旅行の夜」の学習では、自由と自分勝手の違いについて多くの友達と意見を交流し、考えを深めました。仲間の考えを取り入れたり自由とはどういうことなのかを考えたりする中で、人に迷惑をかけない行動の大切さに気付いていました。
•	「あこがれのパティシエ」の学習では、個性について考えました。自分の長所と短所を振り返り、ポジティブな気持ちと、絵や読書の知識を活かして人と接していきたいと今後のなりたい自分について、考えを広げていました。
•	「心を形に」の学習では、礼儀や挨拶の意味について考えました。友達との交流で多くの考えに触れ、自分の考えをもつことができていました。そして、自分から挨拶することの大切さに気付き、これからはそういう自分になりたいと気持ちを高めていました。
•	「うちらネコの手ボランティア」の学習では、登場人物が災害のあった地域でボランティアを続けることに共感し、社会や人のために行動することについて考えを深めました。自分も簡単にできることからやっていきたいと、なりたい自分について思いを広げていました。
•	「あこがれのパティシエ」の学習では、個性について考えました。自分の長所と短所を振り返り、自分から進んで行動できるようになりたいと、今後のなりたい自分について目標をもち、考えを深めていました。
•	「修学旅行の夜」の学習では、自由と自分勝手の違いについて考えました。友達との交流で多くの意見に触れることで、人と関わるときに自分勝手なことはしない方がいいと改めて確認し、今後のなりたい自分について考えを深めていました。
•	「白旗の少女」の学習では、戦争を経験した人の話を通して、平和と国際親善について考えました。友達との交流や学習のまとめから、戦時中の大変さやその時代の人々の偉大さについて考えを深めていました。
•	「うちらネコの手ボランティア」の学習では、登場人物が災害のあった地域でボランティアを続けることに共感し、社会や人のために行動することについて考えを深めました。今後は自分のことだけではなく、人の役に立つことをしたいと、意欲を高めていました。
•	「修学旅行の夜」の学習では、自由と自分勝手の違いについて多くの友達と意見を交流し、考えを深めました。行動に迷う時には、自分の心をしっかりとコントロールしていきたいと、今後のなりたい自分について、意欲を高めていました。
•	「あこがれのパティシエ」の学習では、個性について考えました。教材に登場する人物と自分を重ねながら、ポジティブな自分の長所を確認するとともに、今後は嫌いなこととも向き合っていきたいと、なりたい自分について考えを深めていました。
•	「修学旅行の夜」の学習では、自由と自分勝手の違いについて考えました。友達との交流で多くの意見に触れ、自分ならどうするか、どのように行動したらいいのか、深く考えていました。自由と自分勝手の違いを意識していきたいと、自分を見つめていました。
•	「ピアノの音が…」の学習では、集合住宅に住む人々の騒音問題に対する解決の仕方に触れ、権利と義務について考えました。教材の登場人物の行動に共感し、相手の意見を尊重して受け止めることの必要性に気付き、自分もそうしたいとなりたい自分について考えを広げていました。
•	「ピアノの音が…」の学習では、集合住宅に住む人々の騒音問題に対する解決の仕方に触れ、権利と義務について考えました。教材の登場人物の行動に共感し、相手の意見をきちんと聞くことが大切だと、人との関わり方について考えを深めていました。
•	「あこがれのパティシエ」の学習では、個性について考えました。教材に登場する人物と自分を重ね、自分のよさを改めて振り返りました。これからは、好きなことを見付けて貫き通したいと、なりたい自分に向けて意欲を高めていました。
•	「心を形に」の学習では、礼儀や挨拶の意味について考えました。教材における主人公の思いや考えを自分と重ね、これからは表情に気を付けて話しかけたり挨拶したりしていきたいと、今後のなりたい自分について考えを巡らせていました。
•	「修学旅行の夜」の学習では、自由と自分勝手の違いについて考えました。友達との交流で多くの意見に触れることで自由の意味の深さを知り、今後は自由と自分勝手の違いを理解しながら生活を送りたいと、考えを深めていました。
•	「あこがれのパティシエ」の学習では、個性について考えました。自分の長所と短所を振り返るとともに、自分のやりたいことに挑戦しながら長所を生かしていきたいと、これからのなりたい自分のイメージを膨らませていました。
•	「ばかじゃん！」の学習では、友達との関わりについて、教材に登場する人物と自分を重ねながらどのように行動することがよいのか、考えを深めていました。友達は人生に必要な存在だと気付き、コミュニケーションを大切にしていこうと、なりたい自分について考えを巡らせていました。
•	「心を形に」の学習では、礼儀や挨拶の意味について考えました。挨拶や礼儀が自分の心を表すことに気が付き、いろいろな人に笑顔で挨拶をしたり話しかけたりしていきたいと、なりたい自分についてイメージを膨らませていました。
•	「ばかじゃん！」の学習では、友達との関わりについて、教材に登場する人物と自分を重ねながらどのように行動することがよいのか、考えを深めていました。自分の意見は早めに伝えて誤解のないようにしたいと、気持ちを高めていました。
•	「ピアノの音が…」の学習では、集合住宅に住む人々の騒音問題に対する解決の仕方に触れ、権利と義務について考えました。教材の登場人物の行動に共感し、お互いの持っている権利をよく考えて、話合いや行動をしていくことの必要性について気付いていました。
•	「修学旅行の夜」の学習では、自由と自分勝手の違いについて考えました。友達との交流で多くの意見に触れることで自由の意味の深さとその難しさに気付き、これからはどうしたら自分勝手ではないか考えてから行動していこうと、考えを深めていました。
•	「みんないっしょだよ」の学習では、相手の立場に立って人と接することについて考えました。自分の経験と教材の登場人物の行動を重ね、「みんないっしょ」は「みんなちがってみんないい」と同じことだと気付き、考えを深めていました。
•	「ばかじゃん！」の学習では、友達との関わりについて、教材に登場する人物と自分を重ねながらどのように行動することがよいのか、考えを深めていました。今度は言葉に気を付けて、自分の意見を伝えていこうと、気持ちを高めていました。
•	「心をつなぐ音色」の学習では、自分の目指す姿について考えました。教材の登場人物の考え方に共感し、ピアノや勉強をする時に「楽しい」と感じられるような人になりたいと、自分のあこがれる姿をイメージし、気持ちを高めていました。
•	 「正直、誠実」の学習では、登場人物の心の葛藤について多角的に考え、自分の考えをノートに丁寧に整理していました。他者の意見にも耳を傾け、誠実さとは何かについて深く考えようとする姿が見られました。
•	 「よりよい学校生活」のテーマで、グループでの話し合い活動に積極的に参加しました。特に、友人と「協力」して意見をまとめ、発表の際には互いの貢献に「感謝」の言葉を述べる場面がありました。集団の一員としての自覚と他者への配慮が育まれている様子がうかがえました。
•	「いっしょになってわらっちゃだめだ」の学習では、周りに流されずに行動することの大切さについて考えました。「人がだめなことをしていたら注意する。」と主人公の立場を自分に置き換えて真剣に思考を深めていました。
•	 『合い言葉は「話せばわかる！」』の学習では、仲間と分かり合うことについて考えました。話合いで意見が食い違った際には、「相手が納得するまでちゃんとした理由を伝える。」と相手と分かり合うために必要なことについて思考を深めていました。
•	 『「もっこ」をせおって』の学習では、みんなのために働くことの良さについて考えました。これまでの自分の経験も振り返りながら、「みんなのために働くと達成感がある」ことに気付き、これからの生活に生かそうとする思いをもつようになりました。
•	 学習を通して、自分だったらどうするかなどを考えようとする姿が見られるようになりました。善悪の判断の学習では、横入りした友達に注意をする主人公の姿を通して、自分だったら、「『ルールは、守ってね。みんなにも迷惑をかけているよ。』と言う。」という考えをもちました。
•	 学習を通して、主人公に自分を重ね合わせて、考えを深めようとする姿が見られるようになりました。家族愛の学習では、教材の中の母が敵から子を守る姿を通して、「家の人が自分を心配してくれるのは、大好きで宝物のように大切に思ってくれているからだ。」ということに気付きました。
•	 学習を通して、自分の考えと友達の考えを比べて考えようとする姿が見られるようになりました。国や郷土を愛する態度の学習では、友達の意見を聞くことで、「苫小牧には、大きい船やお店屋さん、公園、神社、樽前山などの素敵なところがたくさんある。」ということに気付きました。
•	 学習を通して、これからの自分について考えを深めようとする姿が見られるようになりました。節度、節制の学習では、「これからは、わがままばかり言っていないで、自分でできることは自分でする。」という意欲を高めていました。
•	「友達」について考える学習では、「係の仕事をする時に、一人では心配だったけど、友達が一緒だったからできたことがあった。」と、自身の経験から気付きました。これからは、自分も友達を助けていきたいと改めて考えていました。
•	「約束やきまり」について考える学習では、「友達だから横入りさせてと言うのはだめだとわかっているけど、友達だから言えない。でも、我慢するのはおかしい。」と、決まりを守ることの大切さについて葛藤しながらも考えを深めていました。
•	「友達」について考える学習では「一人で帰る時に、友達が一緒に帰ろうと声を掛けてくれたことが嬉しかった。」と、登場人物と自分の経験を重ねてその時の感情を振り返っていました。これからは自分も友達に声を掛けていきたいと考えていました。
•	「友達」について考える学習では「友達が先に譲ってくれたから仲良くなった。今度は自分も先に譲りたい。」と、仲良くなるための具体的な方法があることにも気付きました。これからも、優しい気持ちで仲良くしていきたいと考えていました。
•	「ぼくのへんしん」では、苦手だった鉄棒の練習をすることで克服する主人公の姿から、努力を続けるために大切だと思う事を考えました。「練習は毎日最大限に頑張りすぎると辛くなるので、少しずつ続けることが大切なのではないか」と自分事として捉え、思考を深めていました。
•	「『もっこ』をせおって」では、働くことの良さについて考えました。自分自身も会社活動や清掃活動で活躍している場面を思い出し、「働くことの良さは、みんなの役に立てる所だ」と、これまでの学校生活を振り返ってその価値を再認識していました。
•	「いっしょになって、わらっちゃだめだ」では、何も考えず、周りに流されて悪口を言ってしまう登場人物と、自分とを重ねて考えました。友達と遊んでいる時に、思わず冗談で相手の悪口を言ってしまったことがあることを振り返り、これからはよく考えてから話そうという思いをもっていました。
•	「わたしの見つけた小さな幸せ」では、病気を治して、美味しいご飯を食べられることや学校に行けることを喜ぶ主人公の姿から、「自分自身も命がないとサッカーをしたり、友達と遊んだりすることができなくなってしまう。」と、命の尊さについて深く感じていました。
•	「何かお手伝いできることはありますか？」では、目が不自由な方に危険があることを伝えられない主人公の気持ちについて考え、「勇気が出ないこともあるけれど、困っている人を見かけたら、「よし、手伝うぞ！」という気持ちで声をかけることが大事だ」と、具体的な行動への意識を高めていました。
•	「一ぴきのセミにありがとう」では、セミの誕生の命の連鎖について考えました。「セミは羽化してからの人生がとても短いのに、命がけで羽化していることが分かった。それは、命がけでも子孫を残していきたいからではないか」と、生き物の命の連鎖について深く考えていました。
•	「合い言葉は「話せば分かる！」」では、外国からきたトムが掃除をしないことについて葛藤する主人公の気持ちについて考えました。クラスのみんなとトムの両者の気持ちを考慮した上で、自分の考えを伝え、相手の気持ちを理解することの大切さについて思いを深めていました。
•	教材の登場人物の生き方に触れ、これからの生活に生かそうとする姿が見られました。「友情や信頼関係」についての学習では、主人公の姿から、「相手のことを思って行動する」ことが大切だと気付き、これからの生活に生かそうとしていました。
•	自分の生活を見つめ、振り返りながら自分事として考える姿が見られました。「友情や信頼関係」についての学習では、「限られた時間の中でがんばる事の大切さ」や「友達が失敗したらカバーする」など自分の事だけでなく相手との関係が大切であることに気が付いていました。
•	自分の生活を見つめ、振り返りながら、自分事として考える姿が見られました。「善悪の判断」についての学習では、「良いこと悪いことの区別をし、先の事を考えて行動する」と考え、見通しをもって行動する大切さについて改めて考えていました。
•	教材の問題点を自分事として受け止め、考える姿が見られました。「友情や信頼関係」についての学習では、「相手の動きと気持ちを考えて行動したい」と自分だけではなく相手との双方向の関係が大切なことに気付いていました。
•	自分の生活を見つめ、振り返りながら、自分事として考える姿が見られました。「家族との信頼関係」の学習では、「家族にしてもらっていることを当たり前だと思わない」ことや「自分の事を支えてくれる家族だから、自分も協力して支える」など、考えを深めていました。
•	教材の登場人物の生き方に触れ、これからの生活に生かそうとする姿が見られました。「友情や信頼関係」についての学習では、主人公の姿から「信頼関係を築くには、人に親切にしないと親切にしてもらえない」と気付き、これからの生活に生かそうとしていました。
•	自分の生活を見つめ、振り返りながら、自分事として考える姿が見られました。「自然との関わり」についての学習では、「せっかく命をくれているのに残したら失礼」と命の大切さについて改めて気付いていました。
•	友達と意見交流することで物事を様々な視点で考える姿が見られました。「自然との関わり」について交流する中で、「一生懸命に生きていた動物の命を無駄にしたくはない」と命の大切さについて考えを深めていました。
•	友達と意見交流することで物事を様々な視点で考える姿が見られました。「家族と信頼関係」について考える学習では、友達と考えを交流する中で、これまで家族にしてもらって当たり前だと思っていた事がそうではなかったことに気付き、今後の生活に生かそうとしていました。
•	自分の生活を見つめ、振り返りながら、自分事として考える姿が見られました。「家族との信頼関係」についての学習では、家庭の中での自分の役割を考え、「言われなくても自分からお手伝いをする」など、これからの生活に生かそうとしていました。
•	自分の生活を見つめ、振り返りながら自分事として考える姿が見られました。「家族との信頼関係」について考える学習では、日常を振り返り「バレーボールに連れて行ってもらってるから、ありがとうと言う」と家族と良い関係を気付くために必要なことを考えていました。
•	自分の生活を見つめ、振り返りながら、自分事として考える姿が見られました。「自然との関わり」についての学習では、「食べ物一つ一つに命がある。ありがたく食べる。」と命の大切さについて改めて気付いていました。
•	教材の問題点を自分事として受け止め、考える姿が見られました。「家族との信頼関係」の学習では、「信じ合うこと」や「家族みんなで支え合うこと」が大切だと考え、家族のために役立つことの良さについて考えを深めていました。
•	教材の登場人物と同じような経験を思い出し、どのような気持ちだったかを考えました。特に、「親切や思いやり」に関わる学習では『頑張ってね。』と声をかけてもらって嬉しかったから、自分も友達に優しく声をかけたい。」と考えていました。
•	教材の登場人物と同じような経験を思い出し、どのような気持ちだったかを考えました。特に、「親切や思いやり」に関わる学習では「体育でボールを投げる時に『頑張ってね。』と声をかけてもらって嬉しかったから、自分も応援できる人になりたい。」と考えていました。
•	授業を通して改めて気付いたことを、今後の生活に生かそうと考えるようになりました。特に、「相手の立場や気持ち」を考える学習では「友達だからこそ、けんかができて、分かりあえる」という信頼関係に気付いたのでこれからも友達を大切にしていきたいと考えていました。
•	教材の登場人物と同じような経験を思い出し、どのような気持ちだったかを考えました。特に、「友達」に関わる学習では、「けんかをしたら、悲しい気持ちになるからけんかはしたくない」と、友達とのかかわり方ついて考えていました。
•	「自分らしさ」について考える学習では、「分にも良い所がたくさんある」と友達と交流することで改めて気付き、「これからも良さを伸ばして頑張っていきたいし、友達の良さもたくさん伝えていきたい」と考えていました。
•	教材の登場人物になりきって、同じような経験を思い出し、どのような気持ちだったかを発言し、考えることができました。特に、「友達」に関わる学習では「大丈夫？」と声をかけてもらって嬉しかったから、これからは、自分も友達に声をかけていきたい」と考えていました。
•	「ノンステップバスでのできごと」の学習では、思いやりの気持ちと行動について考えました。学習を通して、「思いやりは、相手の立場を考えること。」と、自分の周りの人達への振る舞いを今後の日常生活に生かそうと意欲を高めていました。
•	「かれてしまったヒマワリ」の学習では、水やりを怠った結果、ヒマワリを枯らしてしまった主人公の行動に対して、「枯れたのは、誰も助けなかった周りの人達にも責任がある。」と、よりよい集団生活を送るためには、みんなで協力していくことが必要だと考えました。
•	「かれてしまったヒマワリ」の学習では、水やりを怠った結果、ヒマワリを枯らしてしまった主人公の行動に対して、「主人公にも責任はあるけれど、周りの友達や先生も枯らす前に手伝うことができたのではないか。」と、広い視野でよりよい集団生活をしていくための考えをもちました。
•	「遠足の子どもたち」の学習では、「自由」と「自分勝手」の違いについて考えました。学習を通して、「責任のある行動がとれることが自由。」と、自由の大切さを理解し、今後の生活に生かそうと意欲を高めていました。
•	「アイヌ文化を継承した少女 知里幸恵」の学習では、病にかかりながらも原稿を書き続ける知里幸恵の行動に対し、「それが自分の使命だと感じていたのではないか。」と、考えをもちました。授業の終わりには、「文化を伝承していくことが、先住民の努力を無駄にしないことに繋がっていく。」と、受け継がれていく文化について深く考えていました。
•	「お父さんは救急救命士」の学習では、誇りをもって仕事をする主人公と自分を重ねながら、働くことについて考えました。「将来は、人の為に役に立つ仕事がしてみたい。」と考えをもち、社会に貢献する大切さに気付いていました。
•	「転校生がやってきた」の学習では、いじめを止めようと立ち向かう主人公の行動に対し、「たった1人の発言や行動から、集団は良い方向に変えることが出来る。」と、正義感を大切にする意識を高めていました。
•	「ノンステップバスでのできごと」では、思いやりの心について考えました。主人公の行動と、これまでの自分を重ね、「人の気持ちを考え、自分以外のことも考えることが大切。」と考えをもち、共感した友達との話し合いでさらに考えを深めていました。
•	「ペンギンは水の中を飛ぶ鳥だ」の学習では、周りに無理だと言われ続けた主人公が、夢を叶えたことに対し、「だめだ…は、まずやってから言う言葉だ。」と考えをもち、理想の実現には諦めないことが大切だと気付いていました。
•	「転校生がやってきた」の学習では、いじめのある学級を題材に正義について考えました。「いじめを注意することだけが正義ではなく、賛同しないことや、その時自分にできることを考えることが大切だ。」と共感した友達と交流し、考えを深めていました。
•	「かれてしまったヒマワリ」の学習では、クラスで決めた水やりを怠り、ヒマワリを枯れてしまった主人公だけに責任があるわけではなく、「人任せにしたクラスのみんなにも責任はある。」と考え、よりよい集団生活を送るためには、みんなで協力していくことが大切なことだと気付いていました。
•	「駅前広場はだれのもの」の学習では、きまりは、「みんなが過ごしていくうえで大事な存在である。」という考えをもちました。また、「きまりがあるおかげで、世界は平和になっているのではないか。」と、自分以外の誰かと生活していくうえで大切なことは何かについても考えていました。
•	「ペンギンは水の中を飛ぶ鳥だ」の学習では、周りに無理だと言われ続けた主人公が、夢を叶えたことを題材に学習しました。友達の「失敗してもいいから挑戦することが大切。」という言葉に共感し、理想の実現に向けて大切なことは何か、交流を通して考えを広げていました。
•	「ノンステップバスのできごと」の学習では、友達との交流を通し、「行動ができなくても、相手の立場になって人の気持ちを考えることが大切。」と、思いやりは行動することだけではなく、心で何かを考えることで成り立つと気付いていました。
•	「ありがとう上手に」の学習では、「自分のクラスのほとんどの人が、『ありがとう』という言葉を素直に使えていてすごい。」ということに気付き、振り返りました。また、友達と交流することで、人を自然にプラスな気持ちにできる人は素敵な人だと考えを広げていました。
•	「お父さんは救急救命士」の学習では、誇りをもって仕事をする主人公に対し、「自分も責任をもって仕事をすることで信頼される人になりたい。」と考えをもちました。また、同じ考えをもつ友達との交流を通し、「任された仕事をやり遂げることが信頼につながる。」ということに気付いていました。
•	「かれてしまったヒマワリ」の学習では、クラスで決めた水やりを怠り、ヒマワリを枯らしてしまった主人公だけに責任があるわけではなく、「人任せにしたクラスのみんなや先生にも責任はある。」という考えに共感し、見て見ぬふりをせず協力して生活することが大切だと気付いていました。
•	授業を通して改めて気付いたことを、今後の生活に生かそうと考えるようになりました。特に、「自分らしさ」について考える学習では、「自分にも良い所がたくさんある」と友達と交流することで改めて気付き、「これからも良さを伸ばして頑張っていきたいし、友達の良さもたくさん伝えていきたい」と、今後に生かそうとしていました。
•	登場人物の思いや行動を自分事として捉え、考えるようになりました。特に、「家族」について考えたときには「自分から行動した時には、たくさん褒めてもらった。だから、これからは、進んで行動したい。」と、今後の生活に、生かそうとしていました。
•	授業を通して気付いたことを、今の自分に生かすには、どうしたらよいのかということを考えました。特に、「家族」に関わる学習では「サッカーで得点した時に、家族が喜んでくれて嬉しくなった」と登場人物に自分を重ねて考えていました。「これからも、サッカーだけでなく勉強も頑張る」と今後の生活に対して広く考えていました。
•	教材の問題点を自分事として受け止め、今後の生活に生かそうと考えるようになりました。特に、「約束やきまり」について考える学習では「人に言われる前に、自分から行動することが大事だ」と発言し、集団生活の中で「自分にできることは何か」と考えました。
•	教材の登場人物になりきって、同じような経験を思い出し、どのような気持ちだったかを発言し、考えることができました。特に、「友だち」に関わる学習では「大丈夫？と声をかけてもらって嬉しかったから、自分も声をかけたい」と、具体的な姿を思い描き、今後に生かそうとしていました。
•	教材の登場人物になりきって、同じような経験を思い出し、どのような気持ちだったかを発言し、考えることができました。特に、「友達」に関わる学習では、「本当の友達なら、話したら分かってくれるから、これからも、本当の気持ちを言える友達をたくさん作っていきたい」と、具体的な姿を思い描き、今後に生かそうとしていました。
•	教材の登場人物になりきって、同じような経験を思い出し、どのような気持ちだったかを発言し、考えることができました。特に、「親切や思いやり」に関わる学習では「体育で失敗した時に、大丈夫だよと声をかけてもらって嬉しかったから、自分も声をかけたい」と、具体的な姿を思い描き、今後に生かそうとしていました。
•	教材の問題点を自分事として捉え、考えを深めるようになりました。特に、「相手の立場や気持ち」を考える学習では「友達だからこそ、けんかができて、分かりあえる」という信頼関係に気付き、考えを深めました。　　
•	教材の問題点を自分事として受け止め、今後の生活に生かそうと考えるようになりました。特に、「約束やきまり」について考える学習では「気づいたらすぐにやめる、自分から行動することが大事だ」と発言し、集団生活の中で「自分にできることは何か」と考えました。
•	授業を通して改めて気付いたことを、今後の生活に生かそうと考えるようになりました。特に、「自然愛護」について考える学習では「虫の存在が、自分の命にもつながっている」ことに気付き、「生き物の命も大事にしていこう」と考えを新たにしていました。
•	教材の登場人物になりきって、自分の経験を思い出し、どのような気持ちだったかを考えることができました。特に、相手の立場を考える学習では「けんかをして自分から謝ることは難しいけれど、勇気をもって謝っている人がいる」と発表し、自分もそういう人になりたいと、考えを新たにしました。
•	教材の登場人物になりきって、自分の経験を思い出し、どのような気持ちだったかを考えることができました。特に、「友達」に関わる学習では、「けんかをしたら、悲しい気持ちになるからけんかはしたくない」と、具体的な姿を思い描き、今後に生かそうとしていました。
•	「じぶんでオッケー」の学習では、２年生に進級して張り切っている主人公と自分とを重ね合わせ、自分できるようにしたいことについて考えました。自分の生活を見直し、「自分でできることをどんどん増やしていきたい。」とワークシートにまとめました。前向きに行動することの良さについて考えました。
•	「ともだちやもんな、ぼくら」の学習では、友だちを助けに行こうか迷う主人公の気持ちに寄り添いながら、友達との関わりについて考えました。　
•	「自分が、いやだと思うことは友だちにしない。」と、友達と仲良くするために大切だと思うことについて考えました。"
•	「くまくんのたからもの」の学習では、「助けたねずみくんからもらったドングリにこめられた思いを受け取ったくまくんの思いと自分の経験を重ね合わせながら、親切について考えました。「給食の時、ゴミを拾っていい気持ちになった。親切にしてもらったときは、私も今度は親切にしてあげたい。親切は、自分も相手もいい気持ちになる。」と、親切で人と人とが繋がっていくことに気付きました。
•	「ひかり小学校のじまんはね」の学習では、友だちと話し合いながら、学校生活を振り返りました。「進んで学習をし、きちんと仕事ができるところがいいところ。」と、自分のクラスの友達の良さであり、好きなところだと日頃の生活を見つめ直していました。
•	「自分でオッケー」の学習では、前向きに行動しようとする主人公と自分とを重ね合わせ、自分できることのよさについて考えました。自分の生活を見直し、「２年生になったので、家の人に起こされないようにしたい。」と語り、自立した生活を送ることの大切さについてよく考えました。
•	「いそいでいても」の学習では、お話の登場人物の姿と自分の生活をふりかえりながら、気持ちのよい挨拶や言葉遣いについて考えました。「優しい笑顔で挨拶するようにしている。しっかりできると、自分も相手も気持ちがいい。」と、気持ちのよい挨拶について考えました。
•	「じぶんでオッケー」の学習では、前向きに行動しようとする主人公と自分とを重ね合わせ、自分できることについて考えました。自分の生活を見直し、「２年生になったので、自分で起きる。はやく着替える。早寝早起きをする。」とワークシートにまとめました。自立した生活を送ることの大切さについて考えました。
•	「くまくんのたからもの」の学習では、助けたねずみくんからもらったドングリにこめられた思いを受け取ったとくまくんの思いと自分の経験を重ね合わせながら、親切の良さについて考えました。
•	「転んだ友だちに、大丈夫と言ったら、ありがとうと言われたときのことや自分が困ったとき、助けてもらったときのうれしさや感謝の気持ち」を思い起こし、親切が人と人との温かいつながりをもたらすことについて考えました。"
•	「さかあがりできたよ」の学習では、何度も練習し続けてできるようになった主人公のうれしい気持ちと自分の経験を重ね合わせながら考えました。頑張って前回りができるようになったときの喜びを思い返し、諦めずに最後まで頑張ることの大切さについて考え、さらに新たな目標を持ちました。
•	「わすれられないえがお」の学習では、主人公と自分の経験を重ね合わせながら、正しい行動について考えました。正しいと思ったことをすぐに実行できなかったことを思い返しながら、「わざとじゃなくても、間違ったときは、謝ることで、自分の心の中がすうっとなるし、相手もいい気持ちになる。」とワークシートにまとめ、どう行動するとよいか考えました。
•	「だっておにいちゃんだもん」の学習では、主人公の姿と自分自身の経験を重ね合わせながら、家族の役に立つことについて考えました。「お母さんが忙しいとき、妹のおむつを替えて、ありがとうと言われ、うれしかった。これからも、続けたい。」と、家族の役に立てた喜びを思い起こし、これからも、自分ができることは何かを考えました。
•	「じぶんでオッケー」の学習では、２年生に進級してやる気いっぱいの主人公と自分とを重ね合わせ、自分できるようにしたいことについて考えました。自分の生活を見直し、「自分で片付けや勉強をする。ママの話をよく聞く。」と新たにできるようになりたいことをワークシートにまとめました。前向きに行動することの良さについて考えました。
•	「だっておにいちゃんだもん」の学習では、主人公の思いを通し、自分自身の経験を重ね合わせながら、家族の役に立つことについて考えました。「妹やお母さんの役に立ち、我慢もあったが、ほめられてうれしかった。何かできることをして役に立ちたい。」と、家族の役に立つことの喜びを思い起こし、これから、自分に何ができるかを考えました。
•	「森のともだち」の学習では、お話を通して、友達のことを思って、戻ってくる登場人物の行動に共感しながら、友達の良さについて考えました。「友だちと助け合い仲良くしていきたい。」と、友達との関わりを見つめ直し、仲良くする大切さについて考えました。

所見:
`;

  try {
    const contents: Content[] = [{ role: "user", parts: [{ text: prompt }] }];
    const response: GenerateContentResponse = await ai.models.generateContent({
        model: MODEL_NAME,
        contents: contents,
        // No specific thinkingConfig, use default for higher quality.
    });
    
    const text = response.text;
    if (text) {
      return text.trim();
    } else {
      throw new Error("APIから有効なテキスト応答がありませんでした。");
    }
  } catch (error) {
    console.error("Gemini API error:", error);
    if (error instanceof Error) {
        // Check for specific API related error messages if possible
        if (error.message.includes("API key not valid")) {
            throw new Error("Gemini APIキーが無効です。管理者に連絡してください。");
        }
        throw new Error(`所見の生成に失敗しました: ${error.message}`);
    }
    throw new Error("所見の生成中に不明なエラーが発生しました。");
  }
};